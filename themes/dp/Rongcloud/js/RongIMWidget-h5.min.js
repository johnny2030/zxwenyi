var widget=angular.module("RongWebIMWidget",["RongWebIMWidget.conversationServer","RongWebIMWidget.directive","RongWebIMWidget.conversationListServer","RongIMSDKModule","Evaluate","ng-iscroll"]);$(function(){var a=document.documentElement.clientWidth,b=1242,c=100,d=b/c;a>b&&(a=b),document.documentElement.style.fontSize=a/d+"px"}),widget.factory("providerdata",[function(){var a={_cacheUserInfo:[],getCacheUserInfo:function(b){for(var c=0,d=a._cacheUserInfo.length;c<d;c++)if(a._cacheUserInfo[c].userId==b)return a._cacheUserInfo[c];return null},addUserInfo:function(b){var c=a.getCacheUserInfo(b.userId);c?angular.extend(c,b):a._cacheUserInfo.push(b)}};return a}]),widget.factory("widgetConfig",[function(){return{}}]),widget.factory("WebIMWidget",["$q","conversationServer","conversationListServer","providerdata","widgetConfig","RongIMSDKServer",function(a,b,c,d,e,f){function g(a){var c=b._cacheHistory[a.conversationType+"_"+a.targetId]=b._cacheHistory[a.conversationType+"_"+a.targetId]||[];0==c.length&&c.push(new WidgetModule.TimePanl(a.sentTime)),b._addHistoryMessages(a)}var h={},i={displayMinButton:!0,displayConversationList:!1};return h.display=!1,h.init=function(a){if(!window.RongIMLib||!window.RongIMLib.RongIMClient)return void(e.config=a);angular.extend(i,a);var j=(document.getElementById("rong-conversation"),document.getElementById("rong-conversation-list")),k=document.getElementById("rong-widget-minbtn");e.displayConversationList=i.displayConversationList,e.displayMinButton=i.displayMinButton,e.displayConversationList?j&&(j.style.display="inline-block"):j&&(j.style.display="none"),e.displayMinButton?k&&(k.style.display="none"):k&&(k.style.display="inline-block"),RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.init(),RongIMLib.RongIMVoice&&RongIMLib.RongIMVoice.init(),f.init(i.appkey),f.connect(i.token).then(function(a){console.log("connect success:"+a),"function"==WidgetModule.Helper.checkType(i.onSuccess)&&i.onSuccess(a),"function"==WidgetModule.Helper.checkType(d.getUserInfo)&&d.getUserInfo(a,{onSuccess:function(a){b.loginUser.id=a.userId,b.loginUser.name=a.name,b.loginUser.portraitUri=a.portraitUri}}),c.updateConversations(),b._onConnectSuccess&&b._onConnectSuccess()},function(a){a.tokenError?i.onError&&"function"==typeof i.onError&&i.onError({code:0,info:"token 无效"}):i.onError&&"function"==typeof i.onError&&i.onError({code:a.errorCode})}),f.setConnectionStatusListener({onChanged:function(a){switch(h.connected=!1,a){case RongIMLib.ConnectionStatus.CONNECTED:console.log("链接成功"),h.connected=!0;break;case RongIMLib.ConnectionStatus.CONNECTING:console.log("正在链接");break;case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:console.log("其他设备登录");break;case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:console.log("网络不可用")}h.onConnectStatusChange&&h.onConnectStatusChange(a),c._onConnectStatusChange&&c._onConnectStatusChange(a)}}),f.setOnReceiveMessageListener({onReceived:function(a){console.log(a);var e=WidgetModule.Message.convert(a);switch(a.messageType){case WidgetModule.MessageType.VoiceMessage:e.content.isUnReade=!0;case WidgetModule.MessageType.TextMessage:case WidgetModule.MessageType.LocationMessage:case WidgetModule.MessageType.ImageMessage:case WidgetModule.MessageType.RichContentMessage:g(e);break;case WidgetModule.MessageType.ContactNotificationMessage:break;case WidgetModule.MessageType.InformationNotificationMessage:g(e);break;case WidgetModule.MessageType.UnknownMessage:g(e)}"function"==WidgetModule.Helper.checkType(d.getUserInfo)&&d.getUserInfo(e.senderUserId,{onSuccess:function(a){e.content&&a&&(e.content.userInfo=new WidgetModule.UserInfo(a.userId,a.name,a.portraitUri))}}),h.onReceivedMessage&&h.onReceivedMessage(e),b.onReceivedMessage(e),h.display&&b.current&&b.current.targetType==e.conversationType&&b.current.targetId==e.targetId&&RongIMLib.RongIMClient.getInstance().clearUnreadCount(b.current.targetType,b.current.targetId,{onSuccess:function(){},onError:function(){}}),c.updateConversations().then(function(){})}})},h.setConversation=function(a,c,d){b.onConversationChangged(new WidgetModule.Conversation(a,c,d))},h.setUserInfoProvider=function(a){d.getUserInfo=a},h.setGroupInfoProvider=function(a){d.getGroupInfo=a},h.EnumConversationListPosition=WidgetModule.EnumConversationListPosition,h.EnumConversationType=WidgetModule.EnumConversationType,h.show=function(){h.display=!0,h.fullScreen=!1},h.hidden=function(){h.display=!1},h.getCurrentConversation=function(){return b.current},h}]),widget.directive("rongWidget",[function(){return{restrict:"E",templateUrl:"./ts/main.tpl.html",controller:"rongWidgetController"}}]),widget.controller("rongWidgetController",["$scope","WebIMWidget","widgetConfig","conversationListServer","conversationServer",function(a,b,c,d,e){a.main=b,a.widgetConfig=c,b.show=function(){b.display=!0,c.displayConversationList?(d.showSelf=!0,e.hidden()):(d.showSelf=!1,e.show()),b.onShow&&b.onShow(),setTimeout(function(){a.$apply()})},b.hidden=function(){b.display=!1,e.hidden(),d.showSelf=!1,setTimeout(function(){a.$apply()})},a.showbtn=function(){b.display=!0,b.onShow&&b.onShow()}}]);var conversationController=angular.module("RongWebIMWidget.conversationController",["RongWebIMWidget.conversationServer"]);conversationController.controller("conversationController",["$scope","conversationServer","WebIMWidget","conversationListServer","widgetConfig","providerdata",function(a,b,c,d,e,f){function g(){var b=a.$parent.myScroll.wrapper;p=b.scrollerHeight-b.y}function h(){setTimeout(function(){var b=a.$parent.myScroll.wrapper;console.log(b),b.refresh(),b.scrollTo(0,p-b.scrollerHeight)},500)}function i(a){return a.conversationType==WidgetModule.EnumConversationType.CUSTOMER_SERVICE&&a.content&&("1"==b._customService.currentType?a.content.userInfo={name:b._customService.human.name||"客服人员",portraitUri:b._customService.human.headimgurl||b._customService.robotIcon}:a.content.userInfo={name:b._customService.robotName,portraitUri:b._customService.robotIcon}),a}function j(c,d){var e=new RongIMLib.Message,f=new RongIMLib.UserInfo(b.loginUser.id,b.loginUser.name||"我",b.loginUser.portraitUri);return c.user=f,e.content=c,e.conversationType=a.currentConversation.targetType,e.targetId=a.currentConversation.targetId,e.senderUserId=b.loginUser.id,e.messageDirection=RongIMLib.MessageDirection.SEND,e.sentTime=(new Date).getTime()-RongIMLib.RongIMClient.getInstance().getDeltaTime(),e.messageType=d,e}function k(b,c){var d=new RongIMLib.Message,e=null;return b.userInfo=e,d.content=b,d.conversationType=a.currentConversation.targetType,d.targetId=a.currentConversation.targetId,d.senderUserId=a.currentConversation.targetId,d.messageDirection=RongIMLib.MessageDirection.RECEIVE,d.sentTime=(new Date).getTime()-RongIMLib.RongIMClient.getInstance().getDeltaTime(),d.messageType=c,d}function l(){c.onClose&&"function"==typeof c.onClose&&c.onClose(a.currentConversation),e.displayConversationList?(a.showSelf=!1,d.showSelf=!0):a.showSelf=!1,a.messageList=[],a.currentConversation=null,b.current=null}function m(){n=Qiniu.uploader({runtimes:"html5,html4",browse_button:"uploadfile",container:"funcPanel",drop_element:"Messages",max_file_size:"100mb",dragdrop:!0,chunk_size:"4mb",uptoken:b._uploadToken,domain:o,get_new_uptoken:!1,unique_names:!0,filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],prevent_duplicates:!1},multi_selection:!1,auto_start:!0,init:{FilesAdded:function(a,b){},BeforeUpload:function(a,b){},UploadProgress:function(a,b){},UploadComplete:function(){},FileUploaded:function(c,e,f){return a.currentConversation.targetId&&a.currentConversation.targetType?(f=JSON.parse(f),void RongIMLib.RongIMClient.getInstance().getFileUrl(RongIMLib.FileType.IMAGE,e.target_name,e.name||"",{onSuccess:function(c){WidgetModule.Helper.ImageHelper.getThumbnail(e.getNative(),6e4,function(e,f){var g=RongIMLib.ImageMessage.obtain(f,c.downloadUrl),h=j(g,WidgetModule.MessageType.ImageMessage);RongIMLib.RongIMClient.getInstance().sendMessage(a.currentConversation.targetType,a.currentConversation.targetId,g,{onSuccess:function(){d.updateConversations().then(function(){})},onError:function(){}}),b._addHistoryMessages(WidgetModule.Message.convert(h)),a.$apply(),a.refreshiScroll()})},onError:function(){}})):void alert("请先选择一个会话目标。")},Error:function(a,b,c){}}})}var n,o="http://7xogjk.com1.z0.glb.clouddn.com/";a.$parent.myScrollOptions={wrapper:{disablePointer:!0,disableTouch:!1,disableMouse:!1,snap:!1,click:!0}},a.refreshiScroll=function(){setTimeout(function(){var b=a.$parent.myScroll.wrapper;console.log(b),b.refresh(),b.scrollTo(0,b.wrapperHeight-b.scrollerHeight)},500)};var p=0;a.$watch("WebIMWidget.display",function(b,c){b===c||1==b&&a.refreshiScroll()}),b.show=function(){a.showSelf=!0},b.hidden=function(){a.showSelf=!1},a.currentConversation={title:"",targetId:"",targetType:0},a.messageList=[],a.messageContent="",a.WebIMWidget=c,a.widgetConfig=e,a.conversationServer=b,a._inputPanelState=WidgetModule.InputPanelType.person,a.showSelf=!1,a.showemoji=!1,document.getElementById("wrapper").addEventListener("touchstart",function(){a.$apply(function(){a.showemoji=!1})}),a.$watch("showemoji",function(b,c){b!==c&&(b?a.wrapperbottom={bottom:"9rem"}:a.wrapperbottom={bottom:"1.35rem"},a.refreshiScroll())}),a.$watch("currentConversation.messageContent",function(b,c){b!==c&&a.currentConversation&&RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(+a.currentConversation.targetType,a.currentConversation.targetId,b)}),a.$watch("_inputPanelState",function(a,b){a!==b&&(a==WidgetModule.InputPanelType.person?setTimeout(function(){n&&n.destroy(),m()}):n&&n.destroy())}),a.$watch("showSelf",function(b,c){b!==c&&(b?(a.refreshiScroll(),setTimeout(function(){n&&n.destroy(),m()},1e3)):n&&n.destroy())}),b.onConversationChangged=function(c){if(e.displayConversationList?(a.showSelf=!0,d.showSelf=!1,a.WebIMWidget.display=!0):(a.showSelf=!0,a.WebIMWidget.display=!0),!c||c.targetType!=WidgetModule.EnumConversationType.CUSTOMER_SERVICE||b.current&&b.current.targetId==c.targetId||RongIMLib.RongIMClient.getInstance().startCustomService(c.targetId,{onSuccess:function(){},onError:function(){console.log("连接客服失败")}}),!c||!c.targetId)return a.messageList=[],a.currentConversation=null,b.current=null,void setTimeout(function(){a.$apply()});b.current=c,a.currentConversation=c,b._cacheHistory[c.targetType+"_"+c.targetId]=b._cacheHistory[c.targetType+"_"+c.targetId]||[];var f=b._cacheHistory[c.targetType+"_"+c.targetId]||[];0==f.length?b._getHistoryMessages(+c.targetType,c.targetId,3).then(function(d){a.messageList=b._cacheHistory[c.targetType+"_"+c.targetId],a.messageList.length>0&&(a.messageList.unshift(new WidgetModule.TimePanl(a.messageList[0].sentTime)),d.has&&a.messageList.unshift(new WidgetModule.GetMoreMessagePanel),a.refreshiScroll())}):a.messageList=f,a.currentConversation.messageContent=RongIMLib.RongIMClient.getInstance().getTextMessageDraft(+a.currentConversation.targetType,a.currentConversation.targetId)||"",setTimeout(function(){a.$apply()})},b.onReceivedMessage=function(c){if(a.currentConversation&&c.targetId==a.currentConversation.targetId&&c.conversationType==a.currentConversation.targetType){a.$apply();var d=null;switch(c.messageType){case WidgetModule.MessageType.HandShakeResponseMessage:b._customService.type=c.content.data.serviceType,b._customService.companyName=c.content.data.companyName,b._customService.robotName=c.content.data.robotName,b._customService.robotIcon=c.content.data.robotIcon,b._customService.robotWelcome=c.content.data.robotWelcome,b._customService.humanWelcome=c.content.data.humanWelcome,b._customService.noOneOnlineTip=c.content.data.noOneOnlineTip,"1"==c.content.data.serviceType?(q(WidgetModule.InputPanelType.robot),c.content.data.robotWelcome&&(d=k(RongIMLib.TextMessage.obtain(c.content.data.robotWelcome),WidgetModule.MessageType.TextMessage))):"3"==c.content.data.serviceType?(c.content.data.robotWelcome&&(d=k(RongIMLib.TextMessage.obtain(c.content.data.robotWelcome),WidgetModule.MessageType.TextMessage)),q(WidgetModule.InputPanelType.robotSwitchPerson)):q(WidgetModule.InputPanelType.person),a.evaluate.valid=!1,setTimeout(function(){a.evaluate.valid=!0},6e4);break;case WidgetModule.MessageType.ChangeModeResponseMessage:switch(c.content.data.status){case 1:b._customService.human.name=c.content.data.name||"客服人员",b._customService.human.headimgurl=c.content.data.headimgurl,q(WidgetModule.InputPanelType.person);break;case 2:"2"==b._customService.type?q(WidgetModule.InputPanelType.person):"1"!=b._customService.type&&"3"!=b._customService.type||q(WidgetModule.InputPanelType.robotSwitchPerson);break;case 3:q(WidgetModule.InputPanelType.robot),d=k(RongIMLib.InformationNotificationMessage.obtain("你被拉黑了"),WidgetModule.MessageType.InformationNotificationMessage);break;case 4:q(WidgetModule.InputPanelType.person),d=k(RongIMLib.InformationNotificationMessage.obtain("已经是人工了"),WidgetModule.MessageType.InformationNotificationMessage)}break;case WidgetModule.MessageType.TerminateMessage:0==c.content.code?(a.evaluate.CSTerminate=!0,a.close()):q("1"==b._customService.type?WidgetModule.InputPanelType.robot:WidgetModule.InputPanelType.robotSwitchPerson);break;case WidgetModule.MessageType.CustomerStatusUpdateMessage:switch(Number(c.content.serviceStatus)){case 1:q("1"==b._customService.type?WidgetModule.InputPanelType.robot:WidgetModule.InputPanelType.robotSwitchPerson);break;case 2:q(WidgetModule.InputPanelType.person);break;case 3:q(WidgetModule.InputPanelType.notService)}}if(d){var e=WidgetModule.Message.convert(d);i(e),b._addHistoryMessages(e)}i(c),setTimeout(function(){a.refreshiScroll()},200)}},b._onConnectSuccess=function(){RongIMLib.RongIMClient.getInstance().getFileToken(RongIMLib.FileType.IMAGE,{onSuccess:function(a){b._uploadToken=a.token,setTimeout(function(){m()},1e3)},onError:function(){}})},a.getHistory=function(){g();var c=b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId];c.splice(0,c.length),b._getHistoryMessages(+a.currentConversation.targetType,a.currentConversation.targetId,20).then(function(c){a.messageList=b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId],a.messageList.unshift(new WidgetModule.TimePanl(a.messageList[0].sentTime)),c.has&&b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].unshift(new WidgetModule.GetMoreMessagePanel),h()})},a.getMoreMessage=function(){g(),b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].shift(),b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].shift(),b._getHistoryMessages(+a.currentConversation.targetType,a.currentConversation.targetId,20).then(function(c){a.messageList=b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId],a.messageList.unshift(new WidgetModule.TimePanl(a.messageList[0].sentTime)),c.has&&b._cacheHistory[a.currentConversation.targetType+"_"+a.currentConversation.targetId].unshift(new WidgetModule.GetMoreMessagePanel),h()})};var q=function(c){a._inputPanelState=c,c==WidgetModule.InputPanelType.person?(a.evaluate.type=1,b._customService.currentType="1",b.current.title=b._customService.human.name||"客服人员"):(a.evaluate.type=2,b._customService.currentType="2",b.current.title=b._customService.robotName)};a.evaluate={type:1,showevaluate:!1,valid:!1,CSTerminate:!1,onConfirm:function(c){c&&(1==a.value?RongIMLib.RongIMClient.getInstance().evaluateHumanCustomService(b.current.targetId,c.stars,c.describe,{onSuccess:function(){}}):RongIMLib.RongIMClient.getInstance().evaluateRebotCustomService(b.current.targetId,c.value,c.describe,{onSuccess:function(){}})),RongIMLib.RongIMClient.getInstance().stopCustomeService(b.current.targetId,{onSuccess:function(){},onError:function(){}}),l()},onCancle:function(){RongIMLib.RongIMClient.getInstance().stopCustomeService(b.current.targetId,{onSuccess:function(){},onError:function(){}}),l()}},a.close=function(){if(c.onCloseBefore&&"function"==typeof c.onCloseBefore){c.onCloseBefore({close:function(c){b.current.targetType==WidgetModule.EnumConversationType.CUSTOMER_SERVICE?a.evaluate.valid?a.evaluate.showevaluate=!0:a.evaluate.onCancle():l()}})}else b.current.targetType==WidgetModule.EnumConversationType.CUSTOMER_SERVICE?a.evaluate.valid?a.evaluate.showevaluate=!0:a.evaluate.onCancle():l()},a.send=function(){if(!a.currentConversation.targetId||!a.currentConversation.targetType)return void alert("请先选择一个会话目标。");if(""!=a.currentConversation.messageContent){var c=RongIMLib.RongIMEmoji.symbolToEmoji(a.currentConversation.messageContent),e=RongIMLib.TextMessage.obtain(c),f=new RongIMLib.UserInfo(b.loginUser.id,b.loginUser.name,b.loginUser.portraitUri);e.user=f,RongIMLib.RongIMClient.getInstance().sendMessage(+a.currentConversation.targetType,a.currentConversation.targetId,e,{onSuccess:function(a){d.updateConversations().then(function(){})},onError:function(a){console.log(a)}});var g=j(e,WidgetModule.MessageType.TextMessage),h=WidgetModule.Message.convert(g);if(b._addHistoryMessages(h),a.refreshiScroll(),a.currentConversation.messageContent="",!a.showemoji){var i=document.getElementById("inputMsg");WidgetModule.Helper.getFocus(i)}}},a.minimize=function(){c.display=!1},a.switchPerson=function(){RongIMLib.RongIMClient.getInstance().switchToHumanMode(b.current.targetId,{onSuccess:function(){},onError:function(){}})};setInterval(function(){b._onConnectSuccess()},6e5)}]);var conversationDirective=angular.module("RongWebIMWidget.conversationDirective",["RongWebIMWidget.conversationController"]);conversationDirective.directive("rongConversation",[function(){return{restrict:"E",templateUrl:"./ts/conversation/conversation.tpl.html",controller:"conversationController",link:function(a,b){angular.element(document).bind("touchstart",function(a){var b=document.getElementById("inputMsg");a.target!=b&&b.blur()})}}}]),conversationDirective.directive("swipeEmoji",[function(){return{restrict:"E",scope:{content:"="},templateUrl:"./ts/conversation/swipeEmoji.tpl.html",link:function(a,b,c){var d=document.getElementById("position").getElementsByTagName("li");a.data=[];var e=null;a.$parent.$watch("showemoji",function(b,c){if(b!==c&&!e){for(e=RongIMLib.RongIMEmoji.emojis.slice(0,84).concat();e.length;)a.data.push({emojis:e.splice(0,23),show:!1});a.data[0].show=!0,setTimeout(function(){new window.Swipe(document.getElementById("slider"),{continuous:!0,callback:function(b){for(var c=d.length;c--;)a.data[c].show=!1;a.data[b].show=!0,a.$apply()}})},500)}}),a["delete"]=function(){var b=/\[[\u4e00-\u9fa5]+\]$/;b.test(a.content.messageContent)?a.content.messageContent=a.content.messageContent.replace(b,function(){return""}):a.content.messageContent=a.content.messageContent.substr(0,a.content.messageContent.length-1)}}}}]),conversationDirective.directive("emoji",[function(){return{restrict:"E",scope:{item:"=",content:"="},template:'<div style="display:inline-block"></div>',link:function(a,b,c){b.find("div").append(a.item),b.on("click",function(b){a.content.messageContent=a.content.messageContent||"",a.content.messageContent=a.content.messageContent.replace(/\n$/,""),a.content.messageContent=a.content.messageContent+a.item.children[0].getAttribute("name"),a.$parent.$apply(),b.preventDefault()})}}}]),conversationDirective.directive("contenteditableDire",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){function e(a){return a.replace(new RegExp("<[\\s\\S.]*?>","ig"),"")}function f(){var a=b.html();a=a.replace(/^<br>$/i,""),a=a.replace(/<br>/gi,"\n"),c.stripBr&&"<br>"==a&&(a=""),d.$setViewValue(a)}var g=b[0];a.$watch(function(){return d.$modelValue},function(a){document.activeElement!==g&&(""!==a&&a!==c.placeholder||(g.innerHTML=c.placeholder,g.style.color="#a9a9a9"))}),b.bind("focus",function(){g.innerHTML==c.placeholder&&(g.innerHTML=""),g.style.color=""}),b.bind("blur",function(){""===g.innerHTML&&(g.innerHTML=c.placeholder,g.style.color="#a9a9a9")}),d&&(b.bind("paste",function(a){var b=this;b.innerHTML;c&&clearTimeout(c);var c=setTimeout(function(){b.innerHTML=e(b.innerHTML),d.$setViewValue(b.innerHTML),c=null},50)}),d.$render=function(){b.html(d.$viewValue||"")},WidgetModule.Helper.browser.msie?b.bind("keyup paste",f):b.bind("input",f))}}}),conversationDirective.directive("ctrlEnterKeys",["$timeout",function(a){return{restrict:"A",require:"?ngModel",scope:{fun:"&",ctrlenter:"=",content:"="},link:function(a,b,c,d){a.ctrlenter=a.ctrlenter||!1,b.bind("keypress",function(b){a.ctrlenter?(b.ctrlKey===!0&&13===b.keyCode||10===b.keyCode)&&(a.fun(),a.$parent.$apply(),b.preventDefault()):b.ctrlKey!==!1||b.shiftKey!==!1||13!==b.keyCode&&10!==b.keyCode?b.ctrlKey===!0&&13===b.keyCode||10===b.keyCode:(a.fun(),a.$parent.$apply(),b.preventDefault())})}}}]),conversationDirective.directive("textmessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-text"><div class="rongcloud-arrow-dialog"></div><pre class="rongcloud-Message-entry rongcloud-userMsg" ng-bind-html="msg.content|trustHtml"><br></pre></div></div>'}}]),conversationDirective.directive("imagemessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-img"><span id="{{\'rebox_\'+$id}}" class="rongcloud-Message-entry" style=""><a href="{{msg.imageUri}}"><img ng-src="{{msg.content}}"  data-image="{{msg.imageUri}}" alt=""/></a></span></div></div>',link:function(a,b,c){var d=new Image;d.src=a.msg.imageUri,setTimeout(function(){$("#rebox_"+a.$id).rebox({selector:"a"}).bind("rebox:open",function(){var a=document.getElementsByClassName("rebox")[0];a.onclick=function(b){if("img"!=b.target.tagName.toLowerCase()){var c=document.getElementsByClassName("rebox-close")[0];c.click(),a=null,c=null}}})}),d.onload=function(){},a.showBigImage=function(){}}}}]),conversationDirective.directive("includinglinkmessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-text"><pre class="rongcloud-Message-entry" style="">维护中 由于我们的服务商出现故障，融云官网及相关服务也受到影响，给各位用户带来的不便，还请谅解。  您可以通过 <a href="#">【官方微博】</a>了解</pre></div></div>'}}]),conversationDirective.directive("voicemessage",["$timeout",function(a){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-audio"><span class="rongcloud-Message-entry" style=""><span class="rongcloud-audioBox rongcloud-clearfix " ng-click="play()" ng-class="{\'rongcloud-animate\':isplaying}" ><i></i><i></i><i></i></span><div style="display: inline-block;" ><span class="rongcloud-audioTimer">{{msg.duration}}”</span><span class="rongcloud-audioState" ng-show="msg.isUnReade"></span></div></span></div></div>',link:function(b,c,d){b.msg.duration=parseInt(b.msg.duration||b.msg.content.length/1024),RongIMLib.RongIMVoice.preLoaded(b.msg.content),b.play=function(){RongIMLib.RongIMVoice.stop(b.msg.content),b.isplaying?(b.isplaying=!1,a.cancel(b.timeoutid)):(b.msg.isUnReade=!1,RongIMLib.RongIMVoice.play(b.msg.content,b.msg.duration),b.isplaying=!0,b.timeoutid&&a.cancel(b.timeoutid),b.timeoutid=a(function(){b.isplaying=!1},1e3*b.msg.duration))}}}}]),conversationDirective.directive("locationmessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-map"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-mapBox"><img ng-src="{{msg.content}}" alt=""><span>{{msg.poi}}</span></div></span></div></div>'}}]),conversationDirective.directive("richcontentmessage",[function(){return{restrict:"E",scope:{msg:"="},template:'<div class=""><div class="rongcloud-Message-image-text"><span class="rongcloud-Message-entry" style=""><div class="rongcloud-image-textBox"><h4>{{msg.title}}</h4><div class="rongcloud-cont rongcloud-clearfix"><img ng-src="{{msg.imageUri}}" alt=""><div>{{msg.content}}</div></div></div></span></div></div>'}}]);var conversationServer=angular.module("RongWebIMWidget.conversationServer",["RongWebIMWidget.conversationDirective"]);conversationServer.factory("conversationServer",["$q",function(a){function b(a,b,d){var e=c._cacheHistory[b+"_"+a]=c._cacheHistory[b+"_"+a]||[];e[0]&&e[0].sentTime&&e[0].panelType!=WidgetModule.PanelType.Time&&d.sentTime&&(WidgetModule.Helper.timeCompare(e[0].sentTime,d.sentTime)||e.unshift(new WidgetModule.TimePanl(e[0].sentTime))),e.unshift(d)}var c={};return c.current={targetId:"",targetType:0,title:"",portraitUri:"",onLine:!1},c.loginUser={id:"",name:"",portraitUri:""},c._cacheHistory={},c._getHistoryMessages=function(c,d,e,f){var g=a.defer();return RongIMLib.RongIMClient.getInstance().getHistoryMessages(c,d,f?0:null,e,{onSuccess:function(a,e){for(var f=a.length;f--;){var h=WidgetModule.Message.convert(a[f]);b(d,c,h)}g.resolve({data:a,has:e})},onError:function(a){g.reject(a)}}),g.promise},c._addHistoryMessages=function(a){var b=c._cacheHistory[a.conversationType+"_"+a.targetId]=c._cacheHistory[a.conversationType+"_"+a.targetId]||[];b[b.length-1]&&b[b.length-1].panelType!=WidgetModule.PanelType.Time&&b[b.length-1].sentTime&&a.sentTime&&(WidgetModule.Helper.timeCompare(b[b.length-1].sentTime,a.sentTime)||b.push(new WidgetModule.TimePanl(a.sentTime))),b.push(a)},c.onConversationChangged=function(){},c.onReceivedMessage=function(){},c._customService={human:{}},c}]);var conversationListCtr=angular.module("RongWebIMWidget.conversationListController",[]);conversationListCtr.controller("conversationListController",["$scope","conversationListServer","WebIMWidget",function(a,b,c){a.conversationListServer=b,a.WebIMWidget=c,b.refreshConversationList=function(){setTimeout(function(){a.$apply()})},a.minbtn=function(){b.showSelf=!1},a.connected=!0,b._onConnectStatusChange=function(b){b==RongIMLib.ConnectionStatus.CONNECTED?a.connected=!0:a.connected=!1,setTimeout(function(){a.$apply()})}}]);var conversationListDir=angular.module("RongWebIMWidget.conversationListDirective",["RongWebIMWidget.conversationListController"]);conversationListDir.directive("rongConversationList",[function(){return{restrict:"E",templateUrl:"./ts/conversationlist/conversationList.tpl.html",controller:"conversationListController",link:function(a,b){}}}]),conversationListDir.directive("conversationItem",["conversationServer","conversationListServer",function(a,b){return{restrict:"E",scope:{item:"="},template:'<div class="rongcloud-chat_item"><div class="rongcloud-static_item"><div class="rongcloud-ext"><p class="rongcloud-attr rongcloud-clearfix" ng-show="item.unreadMessageCount>0"><span class="rongcloud-badge badge">{{item.unreadMessageCount>99?"99+":item.unreadMessageCount}}</span></p></div><div class="rongcloud-photo"><img class="rongcloud-img" ng-src="{{item.portraitUri}}" alt=""><i class="rongcloud-Presence rongcloud-Presence--stacked rongcloud-Presence--mainBox"></i></div><div class="rongcloud-info"><h3 class="rongcloud-nickname"><span class="rongcloud-nickname_text">{{item.title}}</span></h3></div></div><div class="rongcloud-delete_box"><span class="rongcloud-sprite2 rongcloud-icon_delete" ng-click="remove($event)"></span></div></div>',link:function(c,d,e){var f,g,h=d[0].querySelector(".rongcloud-chat_item"),i=d[0].querySelector(".rongcloud-delete_box"),j=i.clientWidth,k=function(a){var b=a.changedTouches[0].clientX-f,c=g+b;c<0&&c>-j?h.style["margin-left"]=c+"px":c>0?h.style["margin-left"]="0px":c<-j&&(h.style["margin-left"]=-j+"px")};h.addEventListener("touchstart",function(a){j=i.clientWidth,f=a.changedTouches[0].clientX,h.className="rongcloud-chat_item",g=parseFloat(h.style["margin-left"])||0,document.addEventListener("touchmove",k),document.addEventListener("touchend",l)});var l=function(a){var b=a.changedTouches[0].clientX-f,c=g+b;c>-j/2?(h.className="rongcloud-chat_item rongcloud-chat_item_m rongcloud-normal",h.style["margin-left"]="0px"):(h.className="rongcloud-chat_item rongcloud-chat_item_m rongcloud-remove",h.style["margin-left"]=-j+"px"),document.removeEventListener("touchmove",k),document.removeEventListener("touchend",l)};d.on("click",function(){a.onConversationChangged(new WidgetModule.Conversation(c.item.targetType,c.item.targetId,c.item.title)),RongIMLib.RongIMClient.getInstance().clearUnreadCount(c.item.targetType,c.item.targetId,{onSuccess:function(){},onError:function(){}}),b.updateConversations()}),c.remove=function(a){a.stopPropagation(),RongIMLib.RongIMClient.getInstance().removeConversation(c.item.targetType,c.item.targetId,{onSuccess:function(){b.updateConversations()},onError:function(a){console.log(a)}})}}}}]);var conversationListSer=angular.module("RongWebIMWidget.conversationListServer",["RongWebIMWidget.conversationListDirective","RongWebIMWidget"]);conversationListSer.factory("conversationListServer",["$q","providerdata",function(a,b){var c={};return c.conversationList=[],c.updateConversations=function(){var d=a.defer();return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(a){c.conversationList.splice(0,c.conversationList.length);for(var e=0,f=a.length;e<f;e++){var g=WidgetModule.Conversation.onvert(a[e]);switch(g.targetType){case RongIMLib.ConversationType.PRIVATE:"function"==WidgetModule.Helper.checkType(b.getUserInfo)&&!function(a,c){b.getUserInfo(a.targetId,{onSuccess:function(b){a.title=b.name,a.portraitUri=b.portraitUri,c.conversationTitle=b.name,c.portraitUri=b.portraitUri}})}(g,a[e]);break;case RongIMLib.ConversationType.GROUP:"function"==WidgetModule.Helper.checkType(b.getGroupInfo)&&!function(a,c){b.getGroupInfo(a.targetId,{onSuccess:function(b){a.title=b.name,a.portraitUri=b.portraitUri,c.conversationTitle=b.name,c.portraitUri=b.portraitUri}})}(g,a[e]);break;case RongIMLib.ConversationType.CHATROOM:}c.conversationList.push(g)}d.resolve(),c.refreshConversationList()},onError:function(a){d.reject(a)}},null),d.promise},c.refreshConversationList=function(){},c.getConversation=function(a,b){for(var d=0,e=c.conversationList.length;d<e;d++)if(c.conversationList[d].targetType==a&&c.conversationList[d].targetId==b)return c.conversationList[d];return null},c.addConversation=function(a){c.conversationList.unshift(a)},c._onConnectStatusChange=function(){},c.showSelf=!1,c}]);var widget=angular.module("RongWebIMWidget");widget.service("RongCustomerService",["WebIMWidget",function(a){var b={},c={__isCustomerService:!0};return b.init=function(d){angular.extend(c,d),b._config=d,a.init({appkey:d.appkey,token:d.token,onSuccess:function(a){d.onSuccess&&d.onSuccess(a)}}),a.onShow=function(){a.setConversation(WidgetModule.EnumConversationType.CUSTOMER_SERVICE,d.customerServiceId,"客服")},a.onCloseBefore=function(a){a.close({showEvaluate:!0})}},b.show=function(){a.show()},b.hidden=function(){a.hidden()},b.Postion=Postion,b}]);var Postion;!function(a){a[a.left=1]="left",a[a.right=2]="right"}(Postion||(Postion={}));var directive=angular.module("RongWebIMWidget.directive",[]);directive.filter("trustHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),directive.filter("historyTime",["$filter",function(a){return function(b){var c=new Date;return b.toDateString()===c.toDateString()?a("date")(b,"HH:mm"):b.toDateString()===new Date(c.setTime(c.getTime()-1)).toDateString()?"昨天"+a("date")(b,"HH:mm"):a("date")(b,"yyyy-MM-dd HH:mm")}}]),directive.directive("myTap",[function(){var a=!!("ontouchstart"in window);return function(b,c,d){if(a){var e;c.bind("touchstart",function(){e=!0}),c.bind("touchend",function(){e&&b.$apply(d.myTap),e=!1})}else c.bind("click",function(){b.$apply(d.myTap)})}}]);var evaluate=angular.module("Evaluate",[]);evaluate.directive("evaluatedir",["$timeout",function(a){return{restrict:"E",scope:{type:"=",display:"=",enter:"&confirm",dcancle:"&cancle"},templateUrl:"./ts/evaluate/evaluate.tpl.html",link:function(b,c){function d(c){b.end=!0,c?a(function(){b.display=!1,b.end=!1,b.enter({data:c})},800):(b.display=!1,b.end=!1,b.enter({data:c}))}var e=[!1,!1,!1,!1,!1],f=["答非所问","理解能力差","一问三不知","不礼貌"];b.stars=e.concat(),b.labels=f.concat(),b.end=!1,b.displayDescribe=!1,b.data={stars:0,value:0,describe:"",
label:""},b.$watch("display",function(a,c){a!==c&&(b.displayDescribe=!1,b.data={stars:0,value:0,describe:"",label:""})}),b.confirm=function(a){void 0!=a?1==b.type?(b.data.stars=a,5!=b.data.stars?b.displayDescribe=!0:d(b.data)):(b.data.value=a,b.data.value===!1?b.displayDescribe=!0:d(b.data)):d(null)},b.commit=function(){d(b.data)},b.cancle=function(){b.display=!1,b.dcancle()}}}}]);var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)},WidgetModule;!function(a){!function(a){a[a.left=0]="left",a[a.right=1]="right"}(a.EnumConversationListPosition||(a.EnumConversationListPosition={}));a.EnumConversationListPosition;!function(a){a[a.PRIVATE=1]="PRIVATE",a[a.DISCUSSION=2]="DISCUSSION",a[a.GROUP=3]="GROUP",a[a.CHATROOM=4]="CHATROOM",a[a.CUSTOMER_SERVICE=5]="CUSTOMER_SERVICE",a[a.SYSTEM=6]="SYSTEM",a[a.APP_PUBLIC_SERVICE=7]="APP_PUBLIC_SERVICE",a[a.PUBLIC_SERVICE=8]="PUBLIC_SERVICE"}(a.EnumConversationType||(a.EnumConversationType={}));a.EnumConversationType;!function(a){a[a.SEND=1]="SEND",a[a.RECEIVE=2]="RECEIVE"}(a.MessageDirection||(a.MessageDirection={}));a.MessageDirection;!function(a){a[a.READ=1]="READ",a[a.LISTENED=2]="LISTENED",a[a.DOWNLOADED=4]="DOWNLOADED"}(a.ReceivedStatus||(a.ReceivedStatus={}));a.ReceivedStatus;!function(a){a[a.SENDING=10]="SENDING",a[a.FAILED=20]="FAILED",a[a.SENT=30]="SENT",a[a.RECEIVED=40]="RECEIVED",a[a.READ=50]="READ",a[a.DESTROYED=60]="DESTROYED"}(a.SentStatus||(a.SentStatus={}));var b;a.SentStatus;!function(a){a[a.left=1]="left",a[a.right=2]="right",a[a.top=3]="top",a[a.bottom=4]="bottom"}(b||(b={})),function(a){a[a.person=0]="person",a[a.robot=1]="robot",a[a.robotSwitchPerson=2]="robotSwitchPerson",a[a.notService=4]="notService"}(a.InputPanelType||(a.InputPanelType={}));a.InputPanelType;a.MessageType={DiscussionNotificationMessage:"DiscussionNotificationMessage ",TextMessage:"TextMessage",ImageMessage:"ImageMessage",VoiceMessage:"VoiceMessage",RichContentMessage:"RichContentMessage",HandshakeMessage:"HandshakeMessage",UnknownMessage:"UnknownMessage",SuspendMessage:"SuspendMessage",LocationMessage:"LocationMessage",InformationNotificationMessage:"InformationNotificationMessage",ContactNotificationMessage:"ContactNotificationMessage",ProfileNotificationMessage:"ProfileNotificationMessage",CommandNotificationMessage:"CommandNotificationMessage",HandShakeResponseMessage:"HandShakeResponseMessage",ChangeModeResponseMessage:"ChangeModeResponseMessage",TerminateMessage:"TerminateMessage",CustomerStatusUpdateMessage:"CustomerStatusUpdateMessage"},function(a){a[a.Message=1]="Message",a[a.InformationNotification=2]="InformationNotification",a[a.System=103]="System",a[a.Time=104]="Time",a[a.getHistory=105]="getHistory",a[a.getMore=106]="getMore",a[a.Other=0]="Other"}(a.PanelType||(a.PanelType={}));var c=a.PanelType,d=function(){function a(a){this.panelType=a}return a}();a.ChatPanel=d;var e=function(a){function b(b){a.call(this,c.Time),this.sentTime=b}return __extends(b,a),b}(d);a.TimePanl=e;var f=function(a){function b(){a.call(this,c.getHistory)}return __extends(b,a),b}(d);a.GetHistoryPanel=f;var g=function(a){function b(){a.call(this,c.getMore)}return __extends(b,a),b}(d);a.GetMoreMessagePanel=g;var h=function(a){function b(b){a.call(this,c.Time),this.sentTime=b}return __extends(b,a),b}(d);a.TimePanel=h;var i=function(b){function d(a,d,e,f,g,h,i,j,k,l,m,n,o){b.call(this,c.Message)}return __extends(d,b),d.convert=function(b){var c=new d;switch(c.conversationType=b.conversationType,c.extra=b.extra,c.objectName=b.objectName,c.messageDirection=b.messageDirection,c.messageId=b.messageId,c.receivedStatus=b.receivedStatus,c.receivedTime=new Date(b.receivedTime),c.senderUserId=b.senderUserId,c.sentStatus=b.sendStatusMessage,c.sentTime=new Date(b.sentTime),c.targetId=b.targetId,c.messageType=b.messageType,c.messageType){case a.MessageType.TextMessage:var e=new l,f=b.content.content;f=y.discernUrlEmailInStr(f),RongIMLib.RongIMEmoji&&RongIMLib.RongIMEmoji.emojiToHTML&&(f=RongIMLib.RongIMEmoji.emojiToHTML(f)),e.content=f,c.content=e;break;case a.MessageType.ImageMessage:var g=new r,f=b.content.content||"";f.indexOf("base64,")==-1&&(f="data:image/png;base64,"+f),g.content=f,g.imageUri=b.content.imageUri,c.content=g;break;case a.MessageType.VoiceMessage:var h=new s;h.content=b.content.content,h.duration=b.content.duration,c.content=h;break;case a.MessageType.RichContentMessage:var i=new u;i.content=b.content.content,i.title=b.content.title,i.imageUri=b.content.imageUri,c.content=i;break;case a.MessageType.LocationMessage:var j=new t,f=b.content.content||"";f.indexOf("base64,")==-1&&(f="data:image/png;base64,"+f),j.content=f,j.latiude=b.content.latiude,j.longitude=b.content.longitude,j.poi=b.content.poi,c.content=j;break;case a.MessageType.InformationNotificationMessage:var k=new q;c.panelType=2,k.content=b.content.message,c.content=k;break;case a.MessageType.DiscussionNotificationMessage:var w=new v;w.extension=b.content.extension,w.operation=b.content.operation,w.type=b.content.type,w.isHasReceived=b.content.isHasReceived,c.content=w;case a.MessageType.HandShakeResponseMessage:var x=new m;x.status=b.content.status,x.msg=b.content.msg,x.data=b.content.data,c.content=x;break;case a.MessageType.ChangeModeResponseMessage:var z=new n;z.code=b.content.code,z.data=b.content.data,z.status=b.content.status,c.content=z;break;case a.MessageType.CustomerStatusUpdateMessage:var A=new p;A.serviceStatus=b.content.serviceStatus,c.content=A;break;case a.MessageType.TerminateMessage:var B=new o;B.code=b.content.code,c.content=B;break;case a.MessageType.UnknownMessage:var C=new q;c.panelType=2,C.content="不支持此类型消息请在其他端查看",c.content=C;default:console.log("未处理消息类型:"+b.messageType)}return c.content&&(c.content.userInfo=b.content.user),c},d}(d);a.Message=i;var j=function(){function a(a,b,c){this.userId=a,this.name=b,this.portraitUri=c}return a}();a.UserInfo=j;var k=function(){function a(a,b,c){this.userId=a,this.name=b,this.portraitUri=c}return a}();a.GroupInfo=k;var l=function(){function a(a){a=a||{},this.content=a.content,this.userInfo=a.userInfo}return a}();a.TextMessage=l;var m=function(){function a(){}return a}();a.HandShakeResponseMessage=m;var n=function(){function a(){}return a}();a.ChangeModeResponseMessage=n;var o=function(){function a(){}return a}();a.TerminateMessage=o;var p=function(){function a(){}return a}();a.CustomerStatusUpdateMessage=p;var q=function(){function a(){}return a}();a.InformationNotificationMessage=q;var r=function(){function a(){}return a}();a.ImageMessage=r;var s=function(){function a(){}return a}();a.VoiceMessage=s;var t=function(){function a(){}return a}();a.LocationMessage=t;var u=function(){function a(){}return a}();a.RichContentMessage=u;var v=function(){function a(){}return a}();a.DiscussionNotificationMessage=v;var w=function(){function a(a,b,c){this.targetType=a,this.targetId=b,this.title=c||""}return a.onvert=function(b){var c=new a;return c.targetId=b.targetId,c.targetType=b.conversationType,c.title=b.conversationTitle,c.portraitUri=b.senderPortraitUri,c.unreadMessageCount=b.unreadMessageCount,c},a}();a.Conversation=w;var x=window.navigator.userAgent,y=function(){function b(){}return b.timeCompare=function(a,b){var c=a.toString(),d=b.toString();return c.substring(0,c.lastIndexOf(":"))==d.substring(0,d.lastIndexOf(":"))},b.discernUrlEmailInStr=function(a){var b,c=/\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/gi,d=[];b=a.replace(c,function(a){return d.push(a),"[email`"+(d.length-1)+"]"});var e=/(((ht|f)tp(s?))\:\/\/)?((25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9])\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[1-9]|0)\.(25[0-5]|2[0-4][0-9]|[0-1]{1}[0-9]{2}|[1-9]{1}[0-9]{1}|[0-9])|(www.|[a-zA-Z].)[a-zA-Z0-9\-\.]+\.(com|cn|edu|gov|mil|net|org|biz|info|name|museum|us|ca|uk|me|im))(\:[0-9]+)*(\/($|[a-zA-Z0-9\.\,\;\?\'\\\+&amp;%\$#\=~_\-]+))*/gi;b=b.replace(e,function(a,b){return b?'<a target="_blank" href="'+a+'">'+a+"</a>":'<a target="_blank" href="//'+a+'">'+a+"</a>"});for(var f=0,g=d.length;f<g;f++)b=b.replace("[email`"+f+"]",'<a href="mailto:'+d[f]+'">'+d[f]+"<a>");return b},b.checkType=function(a){var b=Object.prototype.toString.call(a);return b.substring(8,b.length-1).toLowerCase()},b.browser={version:(x.match(/.+(?:rv|it|ra|chrome|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/.test(x),opera:/opera|opr/.test(x),msie:/msie|trident/.test(x)&&!/opera/.test(x),chrome:/chrome/.test(x),mozilla:/mozilla/.test(x)&&!/(compatible|webkit|like gecko)/.test(x)},b.getFocus=function(b){if(b.focus(),b.createTextRange){var c=b.createTextRange();c.moveStart("character",b.value.length),c.collapse(!0),c.select()}else if(b.selectionStart)b.selectionStart=b.value.length;else if(window.getSelection&&b.lastChild){var d=window.getSelection(),e=document.createRange();a.Helper.browser.msie?e.setStart(b.lastChild,b.lastChild.length):e.setStart(b.firstChild,b.firstChild.length),d.removeAllRanges(),d.addRange(e)}},b.ImageHelper={getThumbnail:function(b,c,d){var e=document.createElement("canvas"),f=e.getContext("2d"),g=new Image;g.onload=function(){var a,h,i=g.width*g.height;if(i>c){var j=Math.sqrt(i/c);j=Math.ceil(100*j)/100,a=g.width/j,h=g.height/j}else a=g.width,h=g.height;e.width=a,e.height=h,f.drawImage(g,0,0,a,h);try{var k=e.toDataURL("image/jpeg",.5);k=k.substr(23),d(b,k)}catch(l){d(b,null)}},g.src=a.Helper.ImageHelper.getFullPath(b)},getFullPath:function(a){return window.URL=window.URL||window.webkitURL,window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null}},b}();a.Helper=y}(WidgetModule||(WidgetModule={}));var SDKServer=angular.module("RongIMSDKModule",[]);SDKServer.factory("RongIMSDKServer",["$q",function(a){var b={};return b.init=function(a){RongIMLib.RongIMClient.init(a)},b.connect=function(b){var c=a.defer();return RongIMLib.RongIMClient.connect(b,{onSuccess:function(a){c.resolve(a)},onTokenIncorrect:function(){c.reject({tokenError:!0})},onError:function(a){c.reject({errorCode:a});var b="";switch(a){case RongIMLib.ErrorCode.TIMEOUT:b="连接超时";break;case RongIMLib.ErrorCode.UNKNOWN:b="未知错误";break;case RongIMLib.ConnectionState.UNACCEPTABLE_PROTOCOL_VERSION:b="不可接受的协议版本";break;case RongIMLib.ConnectionState.IDENTIFIER_REJECTED:b="appkey不正确";break;case RongIMLib.ConnectionState.SERVER_UNAVAILABLE:b="服务器不可用";break;case RongIMLib.ConnectionState.NOT_AUTHORIZED:b="未认证";break;case RongIMLib.ConnectionState.REDIRECT:b="重新获取导航";break;case RongIMLib.ConnectionState.APP_BLOCK_OR_DELETE:b="应用已被封禁或已被删除";break;case RongIMLib.ConnectionState.BLOCK:b="用户被封禁"}console.log("失败:"+b)}}),c.promise},b.getInstance=function(){return RongIMLib.RongIMClient.getInstance()},b.setOnReceiveMessageListener=function(a){RongIMLib.RongIMClient.setOnReceiveMessageListener(a)},b.setConnectionStatusListener=function(a){RongIMLib.RongIMClient.setConnectionStatusListener(a)},b.sendMessage=function(b,c,d){var e=a.defer();return RongIMLib.RongIMClient.getInstance().sendMessage(+b,c,d,{onSuccess:function(a){e.resolve(a)},onError:function(a,b){e.reject({errorCode:a,message:b});var c="";switch(a){case RongIMLib.ErrorCode.TIMEOUT:c="超时";break;case RongIMLib.ErrorCode.UNKNOWN:c="未知错误";break;case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:c="在黑名单中，无法向对方发送消息";break;case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:c="不在讨论组中";break;case RongIMLib.ErrorCode.NOT_IN_GROUP:c="不在群组中";break;case RongIMLib.ErrorCode.NOT_IN_CHATROOM:c="不在聊天室中";break;default:c=""}console.log("发送失败:"+c)}}),e.promise},b.reconnect=function(a){RongIMLib.RongIMClient.reconnect(a)},b.clearUnreadCount=function(b,c){var d=a.defer();return RongIMLib.RongIMClient.getInstance().clearUnreadCount(b,c,{onSuccess:function(a){d.resolve(a)},onError:function(a){d.reject(a)}}),d.promise},b.getTotalUnreadCount=function(){var b=a.defer();return RongIMLib.RongIMClient.getInstance().getTotalUnreadCount({onSuccess:function(a){b.resolve(a)},onError:function(){b.reject()}}),b.promise},b.getConversationList=function(){var b=a.defer();return RongIMLib.RongIMClient.getInstance().getConversationList({onSuccess:function(a){b.resolve(a)},onError:function(a){b.reject(a)}},null),b.promise},b.removeConversation=function(b,c){var d=a.defer();return RongIMLib.RongIMClient.getInstance().removeConversation(b,c,{onSuccess:function(a){d.resolve(a)},onError:function(a){d.reject(a)}}),d.promise},b.createConversation=function(a,b,c){RongIMLib.RongIMClient.getInstance().createConversation(a,b,c)},b.getConversation=function(b,c){var d=a.defer();return RongIMLib.RongIMClient.getInstance().getConversation(b,c,{onSuccess:function(a){d.resolve(a)},onError:function(){d.reject()}}),d.promise},b.getDraft=function(a,b){return RongIMLib.RongIMClient.getInstance().getTextMessageDraft(a,b)||""},b.setDraft=function(a,b,c){return RongIMLib.RongIMClient.getInstance().saveTextMessageDraft(a,b,c)},b.clearDraft=function(a,b){return RongIMLib.RongIMClient.getInstance().clearTextMessageDraft(a,b)},b.getHistoryMessages=function(b,c,d){var e=a.defer();return RongIMLib.RongIMClient.getInstance().getHistoryMessages(b,c,null,d,{onSuccess:function(a,b){e.resolve({data:a,has:b})},onError:function(a){e.reject(a)}}),e.promise},b.disconnect=function(){RongIMLib.RongIMClient.getInstance().disconnect()},b.logout=function(){RongIMLib&&RongIMLib.RongIMClient&&RongIMLib.RongIMClient.getInstance().logout()},b.voice={init:function(){},play:function(a,b){RongIMLib.voice.play(a,b)}},b}]),angular.module("RongWebIMWidget").run(["$templateCache",function(a){"use strict";a.put("./ts/conversation/conversation.tpl.html",'<div id=rong-conversation class="rongcloud-main rongcloud-kefuList" ng-show=showSelf><evaluatedir type=evaluate.type display=evaluate.showevaluate confirm=evaluate.onConfirm(data) cancle=evaluate.onCancle()></evaluatedir><div class="rongcloud-main_inner rongcloud-clearfix"><header class=rongcloud-header><a class=rongcloud-icon_return href="javascript:void 0" ng-click=close()></a><div class=rongcloud-title><a class="rongcloud-title_name rongcloud-online"><i class=rongcloud-Presence></i>{{currentConversation.title}}</a></div><a href="javascript:void 0"></a></header><div id=wrapper ng-iscroll ng-style=wrapperbottom><div id=scroller><div id=Messages><div class="rongcloud-MessagesInner rongcloud-message-scroll"><div class=rongcloud-Message-wrapper><div ng-repeat="item in messageList" ng-switch=item.panelType><div class=rongcloud-Messages-date ng-switch-when=104><b>{{item.sentTime|historyTime}}</b></div><div class=rongcloud-Messages-date ng-switch-when=105><b my-tap=getHistory()>查看历史消息</b></div><div class=rongcloud-Messages-date ng-switch-when=106><b my-tap=getMoreMessage()>获取更多消息</b></div><div class=rongcloud-sys-tips ng-switch-when=2><span>{{item.content.content}}</span></div><div class="rongcloud-Message rongcloud-status1" ng-switch-when=1 ng-class="{\'rongcloud-youMsg\':item.messageDirection==2,\'rongcloud-myMsg\':item.messageDirection==1}"><div class=rongcloud-Messages-unreadLine></div><div><div class=rongcloud-Message-header><img class="rongcloud-img rongcloud-u-isActionable rongcloud-Message-avatar rongcloud-avatar" ng-src="{{item.content.userInfo.portraitUri||\'/images/webBg.png\'}}" src=../themes/dp/Rongcloud/images/barBg.png alt=""></div></div><div class=rongcloud-Message-body ng-switch=item.messageType><textmessage ng-switch-when=TextMessage msg=item.content></textmessage><imagemessage ng-switch-when=ImageMessage msg=item.content></imagemessage><voicemessage ng-switch-when=VoiceMessage msg=item.content></voicemessage><locationmessage ng-switch-when=LocationMessage msg=item.content></locationmessage><richcontentmessage ng-switch-when=RichContentMessage msg=item.content></richcontentmessage></div></div></div></div></div></div></div></div><footer class="rongcloud-footer rongcloud-clearfix"><div id=funcPanel style="display: flex;display: -webkit-flex"><a id=uploadfile href=# class="rongcloud-pull-left rongcloud-message_type_btn" ng-show="_inputPanelState==0"><i class="rongcloud-sprite2 rongcloud-icon_message_type1"></i></a> <a href=# class="rongcloud-pull-left rongcloud-message_type2_btn" ng-click=switchPerson() ng-show="_inputPanelState==2"><span>转人工服务</span></a><div class=rongcloud-message_wrap><textarea id=inputMsg ng-focus="showemoji=false" ctrl-enter-keys fun=send() ctrlenter=false ondrop="return false" ng-model=currentConversation.messageContent placeholder=请输入文字...></textarea></div><a href=# class="rongcloud-pull-right rongcloud-message_type_btn rongcloud-message_type_btn2" ng-show="_inputPanelState==0"><i class="rongcloud-sprite2 rongcloud-message_emoji_btn" ng-click="showemoji=!showemoji"></i></a></div><div class=rongcloud-pub-faces ng-show=showemoji><swipe-emoji content=currentConversation></swipe-emoji></div><div class="rongcloud-footerBtn rongcloud-clearfix" ng-show=showemoji><ul class="rongcloud-clearfix rongcloud-emojiWrap"><li class=rongcloud-sprite2></li></ul><a href="" class=rongcloud-send_btn ng-click=send()>发送</a></div></footer></div></div>'),a.put("./ts/conversation/swipeEmoji.tpl.html",'<div class=rongcloud-swipe id=slider><div class=rongcloud-swipe-wrap><figure ng-repeat="item in data"><emoji ng-repeat="it in item.emojis" item=it content=$parent.content></emoji><span class=rongcloud-delete-emoji index=-1 alt="" ng-click=delete()></span></figure></div><ol id=position class=rongcloud-ui-carousel-indicators><li ng-repeat="item in data" ng-class="{\'rongcloud-js-active\':item.show}"></li></ol></div>'),a.put("./ts/conversationlist/conversationList.tpl.html",'<div id=rong-conversation-list class="rongcloud-main rongcloud-kefuList" ng-show=conversationListServer.showSelf><div class="rongcloud-main_inner rongcloud-clearfix"><header class=rongcloud-header><a class=rongcloud-icon_return href="javascript:void 0" ng-click=minbtn()></a><div class=rongcloud-title><a class="rongcloud-title_name rongcloud-online"><i class=rongcloud-Presence></i>最近联系人</a></div><a href="javascript:void 0"></a></header><div class=rongcloud-chatBox id=chatBox><div class=rongcloud-chatArea><div class=rongcloud-chatList><conversation-item ng-repeat="item in conversationListServer.conversationList" item=item></conversation-item></div></div></div></div></div>'),a.put("./ts/evaluate/evaluate.tpl.html",'<div class=rongcloud-layermbox ng-show=display><div class=rongcloud-laymshade></div><div class=rongcloud-layermmain><div class=rongcloud-section><div class=rongcloud-layermchild ng-show=!end><div class=rongcloud-layermcont><div class=rongcloud-type1 ng-show="type==1"><h4>&nbsp;评价客服</h4><div class=rongcloud-layerPanel1><div class=rongcloud-star><span ng-repeat="item in stars track by $index"><span ng-class="{\'rongcloud-star-on\':$index<data.stars,\'rongcloud-star-off\':$index>=data.stars}" ng-click=confirm($index+1)></span></span></div></div></div><div class=rongcloud-type2 ng-show="type==2"><h4>&nbsp;&nbsp;是否解决了您的问题 ？</h4><div class=rongcloud-layerPanel1><a class="rongcloud-btn rongcloud-btnY" ng-class="{\'rongcloud-cur\':data.value===true}" href=javascript:void(0); ng-click=confirm(true)>是</a> <a class="rongcloud-btn rongcloud-btnN" ng-class="{\'rongcloud-cur\':data.value===false}" href=javascript:void(0); ng-click=confirm(false)>否</a></div></div><div class=rongcloud-layerPanel2 ng-show=displayDescribe><p>是否有以下情况 ？</p><div class=rongcloud-labels><span ng-repeat="item in labels"><a class=rongcloud-btn ng-class="{\'rongcloud-cur\':data.label==item}" ng-click="data.label=item" href="">{{item}}</a></span></div><div class=rongcloud-suggestBox><textarea name="" placeholder=欢迎给我们的服务提建议~ ng-model=data.describe></textarea></div><div class=rongcloud-subBox><a class=rongcloud-btn href="" ng-click=commit()>提交评价</a></div></div></div><div class=rongcloud-layermbtn><span ng-click=confirm()>跳过</span><span ng-click=cancle()>取消</span></div></div><div class="rongcloud-layermchild rongcloud-feedback" ng-show=end><div class=rongcloud-layermcont>感谢您的反馈 ^ - ^ ！</div></div></div></div></div>'),a.put("./ts/main.tpl.html","<div><div ng-show=main.display><rong-conversation></rong-conversation><rong-conversation-list></rong-conversation-list></div></div>")}]);